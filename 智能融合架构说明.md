# æ™ºèƒ½èåˆæ¶æ„è¯´æ˜

## ğŸ¯ æ¶æ„æ¦‚è¿°

åŸºäºåˆ†è¯å™¨å…¼å®¹æ€§æµ‹è¯•çš„å‘ç°ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªæ™ºèƒ½çš„åŒè¯­èåˆæ¶æ„ï¼š

- **è‹±æ–‡è¾“å…¥**: PairRMæ’åº + GenFuserèåˆ (åŸæœ‰é«˜è´¨é‡è·¯å¾„)
- **ä¸­æ–‡è¾“å…¥**: PairRMæ’åº + DeepSeek APIèåˆ (æ–°çš„ä¸­æ–‡ä¼˜åŒ–è·¯å¾„)

## ğŸ”¬ æŠ€æœ¯èƒŒæ™¯

### åˆ†è¯å™¨å…¼å®¹æ€§åˆ†æ

é€šè¿‡æµ‹è¯•å‘ç°ï¼š

| æ¨¡å‹ | åˆ†è¯å™¨ | ä¸­æ–‡æ”¯æŒ | è‹±æ–‡æ”¯æŒ | è¯æ±‡è¡¨å¤§å° |
|------|--------|----------|----------|------------|
| PairRM | DebertaV2TokenizerFast | âœ… 100% | âœ… 100% | 128,005 |
| GenFuser | T5TokenizerFast | âŒ 0% | âœ… 80% | 32,100 |

**å…³é”®å‘ç°**ï¼š
- PairRM å¯¹ä¸­è‹±æ–‡éƒ½æœ‰å®Œç¾æ”¯æŒï¼Œå¯ä»¥å‡†ç¡®æ’åº
- GenFuser å¯¹ä¸­æ–‡æ”¯æŒæå·®ï¼ˆ50%æœªçŸ¥æ ‡è®°ï¼‰ï¼Œä½†è‹±æ–‡æ”¯æŒè‰¯å¥½

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ™ºèƒ½è¯­è¨€æ£€æµ‹

```python
def contains_chinese(self, text: str) -> bool:
    """æ£€æµ‹æ–‡æœ¬æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦"""
    return any('\u4e00' <= char <= '\u9fff' for char in text)
```

### 2. èåˆç­–ç•¥é€‰æ‹©

```python
# æ£€æµ‹è¯­è¨€å¹¶é€‰æ‹©èåˆç­–ç•¥
has_chinese = (self.contains_chinese(query) or 
              any(self.contains_chinese(resp.get("content", "")) for resp in responses))

if has_chinese:
    # ä¸­æ–‡: PairRMæ’åº + DeepSeek APIèåˆ
    return await self.call_deepseek_api(query, top_responses, instruction)
else:
    # è‹±æ–‡: PairRMæ’åº + GenFuserèåˆ
    return await self._genfuser_fusion(query, top_responses, instruction, top_k)
```

### 3. DeepSeek API é›†æˆ

#### é…ç½®è¦æ±‚
```bash
# ç¯å¢ƒå˜é‡
export DEEPSEEK_API_KEY="sk-your-deepseek-api-key-here"
```

#### API å‚æ•°
- **æ¨¡å‹**: `deepseek-chat`
- **æ¸©åº¦**: 0.3 (ç¡®ä¿ç¨³å®šè¾“å‡º)
- **æœ€å¤§Token**: 2000
- **è¶…æ—¶**: 30ç§’

## ğŸ“Š èåˆæµç¨‹

### ä¸­æ–‡èåˆæµç¨‹

1. **è¯­è¨€æ£€æµ‹** â†’ è¯†åˆ«ä¸ºä¸­æ–‡
2. **PairRMæ’åº** â†’ å¯¹æ‰€æœ‰å›ç­”è¿›è¡Œè´¨é‡æ’åº
3. **é€‰æ‹©Top-K** â†’ é€‰æ‹©è´¨é‡æœ€é«˜çš„3ä¸ªå›ç­”
4. **æ„å»ºæç¤ºè¯** â†’ ä¸ºDeepSeekæ„å»ºä¸“ä¸šèåˆæç¤º
5. **APIè°ƒç”¨** â†’ è°ƒç”¨DeepSeekè¿›è¡Œæ™ºèƒ½èåˆ
6. **ç»“æœè¿”å›** â†’ è¿”å›èåˆåçš„é«˜è´¨é‡å›ç­”

### è‹±æ–‡èåˆæµç¨‹

1. **è¯­è¨€æ£€æµ‹** â†’ è¯†åˆ«ä¸ºè‹±æ–‡
2. **PairRMæ’åº** â†’ å¯¹æ‰€æœ‰å›ç­”è¿›è¡Œè´¨é‡æ’åº  
3. **é€‰æ‹©Top-K** â†’ é€‰æ‹©è´¨é‡æœ€é«˜çš„3ä¸ªå›ç­”
4. **GenFuserèåˆ** â†’ ä½¿ç”¨æœ¬åœ°GenFuseræ¨¡å‹èåˆ
5. **ç»“æœè¿”å›** â†’ è¿”å›èåˆåçš„é«˜è´¨é‡å›ç­”

## ğŸ›¡ï¸ é™çº§ç­–ç•¥

### å¤šå±‚é™çº§ä¿æŠ¤

1. **DeepSeek API å¤±è´¥** â†’ é™çº§åˆ°ç®€å•æ–‡æœ¬åˆå¹¶
2. **GenFuser åŠ è½½å¤±è´¥** â†’ é™çº§åˆ°ç®€å•æ–‡æœ¬åˆå¹¶
3. **PairRM æ’åºå¤±è´¥** â†’ ä½¿ç”¨åŸå§‹é¡ºåº + ç®€å•åˆå¹¶
4. **ç½‘ç»œé—®é¢˜** â†’ 30ç§’è¶…æ—¶ + è‡ªåŠ¨é‡è¯•

### é”™è¯¯å¤„ç†

```python
try:
    # DeepSeek API è°ƒç”¨
    result = await self.call_deepseek_api(query, top_responses, instruction)
except Exception as e:
    logger.error(f"âŒ DeepSeek API è°ƒç”¨å¤±è´¥: {str(e)}")
    # è‡ªåŠ¨é™çº§åˆ°ç®€å•æ–‡æœ¬èåˆ
    return await self._simple_fusion_from_responses(query, top_responses)
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬è°ƒç”¨

```python
from services.llm_blender_service import get_advanced_fusion_response

# ä¸­æ–‡è¾“å…¥ - è‡ªåŠ¨ä½¿ç”¨DeepSeekèåˆ
result = await get_advanced_fusion_response(
    query="ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ",
    responses=[
        {"modelId": "gpt-4", "content": "AIæ˜¯..."},
        {"modelId": "claude", "content": "äººå·¥æ™ºèƒ½æ˜¯..."}
    ],
    top_k=3
)

# è‹±æ–‡è¾“å…¥ - è‡ªåŠ¨ä½¿ç”¨GenFuserèåˆ  
result = await get_advanced_fusion_response(
    query="What is AI?",
    responses=[
        {"modelId": "gpt-4", "content": "AI is..."},
        {"modelId": "claude", "content": "Artificial intelligence..."}
    ],
    top_k=3
)
```

### 2. è¿”å›ç»“æœæ ¼å¼

```python
{
    "fused_content": "èåˆåçš„å›ç­”å†…å®¹",
    "ranked_responses": [
        {
            "modelId": "gpt-4",
            "content": "åŸå§‹å›ç­”",
            "rank": 1,
            "quality_score": 4
        }
    ],
    "best_response": {...},
    "processing_time": 3.25,
    "models_used": ["gpt-4", "claude", "gemini"],
    "fusion_method": "deepseek_chinese",  # æˆ– "genfuser_english"
    "language_detected": "chinese"       # æˆ– "english"
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥

- **PairRMæ¨¡å‹**: å¸¸é©»å†…å­˜ï¼Œé¿å…é‡å¤åŠ è½½
- **GenFuseræ¨¡å‹**: å¯é€‰åŠ è½½ï¼Œæ”¯æŒå»¶è¿Ÿåˆå§‹åŒ–
- **åˆ†è¯å™¨**: å¤ç”¨tokenizerå®ä¾‹

### 2. å¹¶å‘å¤„ç†

- **å¼‚æ­¥APIè°ƒç”¨**: ä½¿ç”¨ aiohttp è¿›è¡Œéé˜»å¡è¯·æ±‚
- **æ‰¹é‡æ’åº**: PairRMæ”¯æŒæ‰¹é‡å¤„ç†æå‡æ•ˆç‡
- **è¶…æ—¶æ§åˆ¶**: é¿å…é•¿æ—¶é—´ç­‰å¾…å½±å“ç”¨æˆ·ä½“éªŒ

### 3. å†…å­˜ç®¡ç†

```python
# CPUæ¨¡å¼é¿å…GPUå†…å­˜é—®é¢˜
os.environ["CUDA_VISIBLE_DEVICES"] = ""

# æ¨¡å‹é…ç½®
self.blender.loadranker("llm-blender/PairRM", device="cpu")
self.blender.loadfuser("llm-blender/gen_fuser_3b", device="cpu")
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•

```bash
cd software_aibot/backend
python test_smart_fusion.py
```

### æµ‹è¯•è¦†ç›–

- âœ… ä¸­æ–‡è¯­è¨€æ£€æµ‹å’Œèåˆ
- âœ… è‹±æ–‡è¯­è¨€æ£€æµ‹å’Œèåˆ  
- âœ… PairRMæ’åºå‡†ç¡®æ€§
- âœ… APIå¤±è´¥é™çº§å¤„ç†
- âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•

## ğŸ”§ é…ç½®è¯´æ˜

### DeepSeek API é…ç½®

1. **è·å–APIå¯†é’¥**: https://platform.deepseek.com/
2. **è®¾ç½®ç¯å¢ƒå˜é‡**: `DEEPSEEK_API_KEY=sk-xxx`
3. **é…ç½®æ¨¡å‹å‚æ•°**: åœ¨ `llm_blender_service.py` ä¸­è°ƒæ•´

### æ¨¡å‹è·¯å¾„é…ç½®

```python
# PairRMæ’åºæ¨¡å‹
PAIRRM_MODEL = "llm-blender/PairRM"

# GenFuserèåˆæ¨¡å‹  
GENFUSER_MODEL = "llm-blender/gen_fuser_3b"

# DeepSeek API
DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions"
```

## ğŸ¯ ä¼˜åŠ¿æ€»ç»“

### æŠ€æœ¯ä¼˜åŠ¿

1. **æ™ºèƒ½è¯­è¨€é€‚é…**: æ ¹æ®è¾“å…¥è¯­è¨€è‡ªåŠ¨é€‰æ‹©æœ€ä½³ç­–ç•¥
2. **é«˜è´¨é‡æ’åº**: PairRMå¯¹ä¸­è‹±æ–‡éƒ½æœ‰100%æ”¯æŒ
3. **ä¸“ä¸šä¸­æ–‡èåˆ**: DeepSeekä¸“é—¨ä¼˜åŒ–ä¸­æ–‡ç†è§£å’Œç”Ÿæˆ
4. **ç¨³å®šè‹±æ–‡èåˆ**: GenFuseråœ¨è‹±æ–‡åœºæ™¯ä¸‹è¡¨ç°ä¼˜å¼‚
5. **å¤šå±‚é™çº§**: ç¡®ä¿æœåŠ¡é«˜å¯ç”¨æ€§

### ä¸šåŠ¡ä»·å€¼

1. **ç”¨æˆ·ä½“éªŒ**: ä¸­è‹±æ–‡éƒ½èƒ½è·å¾—é«˜è´¨é‡èåˆç»“æœ
2. **æŠ€æœ¯å…ˆè¿›**: ç»“åˆæœ¬åœ°æ¨¡å‹å’Œäº‘ç«¯APIçš„ä¼˜åŠ¿
3. **æˆæœ¬æ§åˆ¶**: åªå¯¹ä¸­æ–‡ä½¿ç”¨ä»˜è´¹APIï¼Œè‹±æ–‡ä½¿ç”¨æœ¬åœ°æ¨¡å‹
4. **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°çš„è¯­è¨€æ”¯æŒå’Œèåˆç­–ç•¥

## ğŸ“ æœªæ¥ä¼˜åŒ–

### çŸ­æœŸä¼˜åŒ–

- [ ] æ·»åŠ æ›´å¤šè¯­è¨€æ£€æµ‹æ”¯æŒ
- [ ] ä¼˜åŒ–DeepSeekæç¤ºè¯æ¨¡æ¿
- [ ] å¢åŠ èåˆè´¨é‡è¯„ä¼°æŒ‡æ ‡
- [ ] å®ç°APIè°ƒç”¨é‡è¯•æœºåˆ¶

### é•¿æœŸè§„åˆ’

- [ ] è®­ç»ƒä¸“é—¨çš„ä¸­æ–‡GenFuseræ¨¡å‹
- [ ] å®ç°å¤šè¯­è¨€æ··åˆè¾“å…¥å¤„ç†  
- [ ] æ·»åŠ ç”¨æˆ·åå¥½å­¦ä¹ 
- [ ] æ„å»ºèåˆè´¨é‡è‡ªåŠ¨è¯„ä¼°ç³»ç»Ÿ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æŸ¥çœ‹ï¼š
- é¡¹ç›®README: `software_aibot/README.md`
- APIæ–‡æ¡£: `software_aibot/API.md`
- æµ‹è¯•è„šæœ¬: `software_aibot/backend/test_smart_fusion.py` 